# 颜色

颜色是外来的光刺激作用于人的视觉器官而产生的主观感觉。因而物体的颜色不仅取决于物体本身，还与光源、周围环境的颜色，以及观察者的视觉系统有关系。
    从心理学和视觉的角度出发，颜色有如下三个特性：色调(Hue)、饱和度(Saturation)和亮度(Lightness)。所谓色调，是一种颜色区别于其它颜色的因素，也就是我们平常所说的红、绿、蓝、紫等；饱和度是指颜色的纯度，鲜红色饱和度高，而粉红色的饱和度低。与之相对应，从光学物理学的角度出发，颜色的三个特性分别为：主波长(Dominant Wavelength)、纯度(Purity)和明度(Luminance)。主波长是产生颜色光的波长，对应于视觉感知的色调；光的纯度对应于饱和度，而明度就是光的亮度。这是从两个不同方面来描述颜色的特性。
    在三维空间中，我们可以用一个纺锤体把颜色的三种基本特性来表示出来（4.1.1）。在颜色纺锤体的垂直轴线上表示白黑系列的亮度变化，顶部是白色，到底部是黑色。在垂直轴线上，从下向上，亮度越来越大。色调由水平圆周表示，圆周上不同角度的点代表了不同色调的颜色，如红、橙、黄、绿、青、蓝、紫等，圆周中心的色调是中灰色，它的亮度和该水平圆周上各色调的亮度相同。从圆心向圆周过渡表示同一色调下饱和度的提高。在颜色纺锤体的一个平面圆形上，它们的色调和饱和度不同，而亮度是相同的。

由于颜色是因外来光刺激而使人产生的某种感觉，我们有必要了解一些光的知识。从根本上讲，光是人的视觉系统能够感知到的电磁波，它的 是波长，当一束光的各种波长的能量大致相等时，我们称其为白光；否则，称其为彩色光；若一束光中，只包含一种波长的能量，其它波长都为零时，称其为单色光。白光、彩色光及其单色光的光谱能量分布分别如图4.1.2、图4.1.3和图4.1.4所示。

事实上，我们可以用主波长、纯度和明度来简洁地描述任何光谱分布的视觉效果。但是由实验结果知道，光谱与颜色的对应关系是多对一的，也就是说，具有不同光谱分布的光产生的颜色感觉是有可能一样的。我们称两种光的光谱分布不同而颜色相同的现象为“异谱同色”。由于这种现象的存在，我们必须采用其它的定义颜色的方法，使光本身与颜色一一对应。 

在物理学上对光与颜色的研究发现，颜色具有具有恒常性。即人们可以根据物体的固有颜色来感知它们，而不会受外界条件变化的影响。颜色之间的对比效应能够使人区分不同的颜色。颜色还具有混合性，牛顿在十七世纪后期用棱镜把太阳光分散成光谱上的颜色光带，用实验证明了白光是由很多颜色的光混合而成。十九世纪初，Yaung提出一种假设，某一种波长的光可以通过三种不同 波长的光混合而复现出来，且红(R)、绿(G)、蓝(B)三种单色光可以作为基本的颜色－原色，把这三种光按照不同的比例混合就能准确的复现其它任何波长的光，而它们等量混合就可以产生白光。后来，Maxwell用旋转圆盘所作的颜色混合实验验证了Yaung的假设。在此基础上，1862年，Helmhotz进一步提出颜色视觉机制学说，即三色学说，也称为三刺激理论。到现在，用三种原色能够产生 各种颜色的三色原理已经成为当今颜色科学中最重要的原理和学说。
    近代的三色学说研究认为，人眼的视网膜中存在着三种锥体细胞，它们包含不同的色素，对光的吸收和反射特性不同，对于不同的光就有不同的颜色感觉。研究发现，第一种锥体细胞专门感受红光，第二和第三种锥体细胞则分别感受绿光和蓝光。它们三者共同作用，使人们产生了不同的颜色感觉。例如，当黄光刺激眼睛时，将会引起红、绿两种锥体细胞几乎相同的反应，而只引起蓝细胞很小的反应，这三种不同锥体细胞的不同程度的兴奋程度的结果产生了黄色的感觉，这与颜色混合时，等量的红和绿加上极小量的蓝色可以复现黄色是相同。
    三色学说是我们真实感图形学的生理视觉基础，我们所采用的RGB颜色模型，以及计算机图形学中其他的颜色模型都是根据这个学说提出来的。我们根据三色学说用RGB来定义我们的颜色，三色学说是我们颜色视觉中最基础、最根本的理论。

由三色学说的原理我们知道，任何一种颜色可以通过红、绿、蓝三原色按照不同比例混合来得到。可是，给定一种颜色，采用怎样的三原色比例才可以复现出该色，以及这种比例是否唯一，是我们需要解决的问题，只有解决了这些问题，我们才能给出一个完整的用RGB来定义颜色的方案。
CIE（国际照明委员会）选取的标准红、绿、蓝三种光的波长分别为：红  颜色的匹配可以用式子表示为。

其中权值r、g、b为颜色匹配中所需要的R、G、B三色光的相对量，也就是三刺激的值。1931年，CIE给出了用等能标准三原色来匹配任意颜色的光谱三刺激值曲线（图4.1.5），这样的一个系统被称为CIE-RGB系统。

# 光照

1.光照
光源分为点光源与无穷远光源，区别在于无穷远光源只在一个方向上照明场景。
光照需要设置光源位置、颜色和光照范围（一个光照向量和该向量开始的角度范围，通常用光照单位向量和物体单位向量的数量积来判断是否在范围内（其实就是cos角的值或符号来判断））。
光强衰减分为距离衰减（纵向，衰减因子1/d太小，1/d^2太大，一般用1/(二次多项式)来作为衰减因子）和角强度衰减（横向，圆锥体光照，光方向向量的光强最强，偏离这个方向向量则开始衰减，直至看不到光）。
2.基本光照模型 
光照模型：计算某一点的光强度的模型。
基本光照模型中的发光体一般限于点光源。
a.环境光
在空间中近似均匀分布，即在任何位置、任何方向上强度一样。（但物体表面所呈现的亮度不一定都一样，因为这还取决于物体表面环境光的反射系数（反射光决定了物体呈现的颜色））。
缺点：虽然不同物体具有不同的亮度，但是同一物体表面的亮度是一个恒定值，没有明暗的自然过渡。
b.漫反射 
粗糙、无光泽物体（黑板）表面对光的反射（和环境光一样，是看光强和材质的漫反射系数强度的）。

上图说明单位面积所接受的光照强度还与角度有关，cosθ*漫反射光照强度*材质漫反射系数（cosθ的计算可有点光源的单位方向向量和物体表面的单位方向向量数量积得出）。
缺点：对于许多物体，使用漫反射+环境光反射计算光强是可以的，但是对于金属等，还需要镜面反射
c.镜面反射
光滑物体表面对光的反射

观察者只能在反射方向上才能看到反射光，偏离了该方向则看不到反射光。
镜面也不是绝对光滑的，会出现散射现象。因此Is=Ip*Ks*(cosθ)^Ns；其中Ip是光照强度，Ks是镜面反射系数，Ns是镜面反射参数（它与镜面的毛糙程度有关，因为镜面粗糙所以反射角不一定完全等于入射角，所以才会有这个反射参数）。
d.Phong光照明模型
就是综合考虑以上三个光对物体的影响，强度计算也就是上面几个光强的叠加。
e.考虑上光的衰减
还可以在各个光照模型上乘上光的衰减因子，使之更加真实

2.透明、雾气、半色调模式和抖动技术
透明：材质透明就会产生折射问题，折射了一部分的光，则该表面的反射光强度就得重新调整了（整个光强-折射的光强）
雾气：从效果来看就是在光照上加个衰减函数
半色调模式
a.运用原理（但这显然会降低分辨率，用10个点来模拟一个点的强度）
当输出设备的光强度范围较小时，可以将多个像素单元组合起来表示一种强度值，从而使得可以得到的强度数增加（因为当我们观察一个包含几个像素的小区域时，眼睛往往通过取整或将细节取平均而得到一个总体的强度效果）。

对于只有黑白两种强度的输出设备，它是这样来表示不同的灰度的：比较暗的地方3*3的矩形小方块里就多打几个黑点，比较亮的地方在3*3的矩形小方块里少打几个黑点。
强度模拟1~10：


抖动技术： 
抖动技术的效果是在整个图像上增加噪音以柔化强度边界

3.多边形绘制算法
a.均匀着色

方法：任取多边形上一点，利用光照明方程计算出它的颜色，用这个颜色填充整个多边形
适用场合：光源在无穷远处；视点在无穷远处；多边形是物体表面的精确表示
缺点：产生的图形效果不好。相邻两个多边形的法向量方向不同，计算出来的颜色也不同，因此造成整个物体表面的颜色过渡不光滑
b.光滑着色
a.Gourand着色方法
基本思想：在每个多边形顶点处计算颜色，然后在各个多边形内部进行线性插值，得到多边形内部个点颜色。
步骤：
1.计算多边形的单位法向量
2.计算多边形顶点的单位法向量（计算方法：与该顶点相邻的所有多边形的法向量平均值近似作为该顶点的近似法向量）
3.利用光照明方程计算顶点光强（颜色）
4.对多边形顶点光强（颜色）进行双线性插值，获得多边形内部各点的光强（颜色）
插值：

a.线性插值（插边界上的点）

b.双线性插值（插内部点）

先用线性插值计算出边上的点的光照强度，在用边上的点计算出内部的点的光照强度。
c.增量算法
对于线性插值来讲，扫描线y递增一个单位变为y+1，增量（以I4为例）是：△I = ( I1 - I2 ) / ( y1 - y2 )；则 Iy+1 = Iy + △I。
对于双线性插值来讲，△I = ( I4 - I5 ) / ( x4 - x5 )。
优点：能有效显示漫反射曲面，计算量小
缺点：高光有时会异常；当对曲面采用不同的多边形进行分割会产生不同的效果（法向量不同了）；会造成该表面出现过亮或过暗的条纹（解决方案：Phong着色方法）。
b.Phong着色方法
基本思想：通过多边形顶点的法向量进行插值，获得其内部个点的法向量，又称为法向量插值着色方法。
步骤：
1.计算多边形单位法向量
2.计算多边形顶点单位法向量
3.对多边形顶点法向量进行双线性插值，获得内部各点的法向量
4.利用光照明方程计算多边形内部各点的颜色
法向量线性（双线性）插值方法和着色的插值方法大致是一样的，只不过此处算的是法向量，而不是颜色值
法向量增量算法和着色的增量算法也是大致相同的，只是此处计算的法向量的值
优点：比Gouraud方法更加真实，体现在高光区域的扩散，产生正确的高光区域
缺点：计算量太大；处理某些多边形分割的曲面时，效果可能还不如Gouraud算法好
4.光线跟踪方法
a.本节参考
http://blog.csdn.net/ryfdizuo/article/details/6252776
http://wenku.baidu.com/view/1aebb91aa8114431b90dd8e2.html?re=view&pn=51
http://www.cnblogs.com/daniagger/archive/2012/05/27/2520254.html
b.原理
由于从光源发出的光线有无穷多条，使得直接从光源出发对光线进行跟踪变得非常困难。实际上，从光源发出的光线只有少数经由场景的反射和透射（折射）后到达观察者的眼中。为此标准光线跟踪算法采用逆向跟踪技术完成整个场景的绘制。
c.光线跟踪思路
从视点出发，通过图像平面上每个像素中心向场景发出一条光线，光线的起点为视点，方向为像素中心和视点连线单位向量。光线与离视点最近的场景物体表面交点有三种可能：
当前交点所在的物体表面为理想漫射面，跟踪结束。
当前交点所在的物体表面为理想镜面，光线沿其镜面发射方向继续跟踪。
当前交点所在的物体表面为规则透射面，光线沿其规则透射方向继续跟踪。

d.步骤伪码
//设置视点，投影平面以及窗口参数
//for(窗口内每一条扫描线)
//{
//	for(扫描线上的每一个像素点)
//	{
//		确定从视点指向像素中心的光线ray
//		像素的颜色=RayTracing(ray,1);	
//	}	
//} 

//Color RayTracing(Ray ray,int depth)
//{
//	求ray与物体表面最近的交点P; 
//	if(有交点) 
//	{
//		用局部光照模型计算环境光Ic; 
//		color=Ic;
//		if(depth<给定的最大跟踪层次)
//		{ 
//			计算ray的反射光线; 
//			Is=RayTracing(反射光线，depth+1); 
// 			if(物体是透明的)
//			{	
//				计算ray的透射光线; 
//				It=RayTracing(透射光线，depth+1); 
//			}
//			color=Ic+Is+It;
//		}
// 	}
//	else
//	{
//		color=背景色; 
//	}
//	return color;
//} 

e.优缺点
优点：能够方便的产生阴影，模拟镜面反射与折射现象。
缺点：计算量大，每条光线都要与场景中的物体进行求交、计算光照模型。
f.光线跟踪的反走样

1.对每一个像素的角点计算光线跟踪的光强
2.比较像素四个角点的光强，确定要进行细分的像素
3.对细分后新增的角点计算光线跟踪的光强。然后，重复2,3步骤，直到各角点的光强比较接近为止
4.加权平均求出投影平面上各像素点的光强

# 相机



# 投影

# 剪裁

# 建模

如何表示象飞机、汽车、轮船等具有复杂外形产品的表面是工程中必须解决的问题。1963年美国波音（Boeing）飞机公司的佛格森（Ferguson）最早引入参数三次曲线，将曲线曲面表示成参数矢量函数形式，构造了组合曲线和由四角点的位置矢量、两个方向的切矢定义的佛格森双三次曲面片。1964年，美国麻省理工学院（MIT）的孔斯（Coons）用封闭曲线的四条边界定义一张曲面。同年，舍恩伯格（Schoenberg）提出了参数样条曲线、曲面的形式。1971年，法国雷诺（Renault）汽车公司的贝塞尔（Bezier）发表了一种用控制多边形定义曲线和曲面的方法。同期，法国雪铁龙（Citroen） 汽车公司的德卡斯特里奥（de Castelijau）也独立地研究出与Bezier类似的方法。1972年，德布尔（de Boor）给出了B样条的标准计算方法。1974年，美国通用汽车公司的戈登（Gorden）和里森费尔德（Riesenfeld）将B样条理论用于形状描述，提出了B样条曲线和曲面。1975年，美国锡拉丘兹（Syracuse）大学的佛斯普里尔（Versprill）提出了有理B样条方法。80年代后期皮格尔（Piegl）和蒂勒（Tiller）将有理B样条发展成非均匀有理B样条方法，并已成为当前自由曲线和曲面描述的最广为流行的技术。 

由于几何外形设计的要求越来越高,传统的曲线曲面表示方法,已不能满足用户的需求。1962年，法国雷诺汽车公司的P.E.Bezier构造了一种以逼近为基础的参数曲线和曲面的设计方法，并用这种方法完成了一种称为UNISURF的曲线和曲面设计系统，1972年，该系统被投入了应用。Bezier方法将函数逼近同几何表示结合起来，使得设计师在计算机上就象使用作图工具一样得心应手。 

几何设计中，一条Bezier曲线往往难以描述复杂的曲线形状。这是由于增加由于特征多边形的顶点数，会引起Bezier曲线次数的提高，而高次多项式又会带来计算上的困难，实际使用中，一般不超过10次。所以有时采用分段设计，然后将各段曲线相互连接起来，并在接合处保持一定的连续条件。下面讨论两段Bezier曲线达到不同阶几何连续的条件。 
    给定两条Bezier曲线P(t)和Q(t)，相应控制点为Pi(i =0,1,...,n)和Qi(i=0,1,...,m)，且令ai=Pi-Pi-1，bi=Qi-Qi-1，如图3.1.13所示，我们现在把两条曲线连接起来。 

所谓升阶是指保持Bezier曲线的形状与方向不变，增加定义它的控制顶点数，也即是提高该Bezier曲线的次数。增加了控制顶点数，不仅能增加了对曲线进行形状控制的灵活性，还在构造曲面方面有着重要的应用。对于一些由曲线生成曲面的算法，要求那些曲线必须是同次的，应用升阶的方法，我们可以把低于最高次数的的曲线提升到最高次数，使得各条曲线具有相同的次数。
    曲线升阶后，原控制顶点会发生变化。下面，我们来计算曲线提升一阶后的新的控制顶点。

以Bernstein基函数构造的Bezier曲线或曲面有许多优越性，但有两点不足：其一是Bezier曲线或曲面不能作局部修改；其二是Bezier曲线或曲面的拼接比较复杂。1972 年，Gordon、Riesenfeld等人提出了B样条方法，在保留Bezier方法全部优点的同时，克服了Bezier方法的弱点。

定义
    与Bezier曲线得定义方法类似，B样条曲线方程定义为： 

    其中，Pi(i=0,1,...,n)是控制多边形的顶点，Ni,k(t)(i=0,1,...,n)称为k阶(k-1次)B样条基函数，其中每一个称为B样条，它是一个称为节点矢量，即非 （k-1次)多项式样条。
    B样条有多种等价定义，在理论上较多地采用截尾幂函数的差商定义。我们只介绍作为标准算法的de Boor-Cox递推定义，又称为de Boor-Cox公式。约定0/0=0。

    该递推公式表明：欲确定第i个k阶B样条Ni,k(t)，需要用到ti,ti+1,...,ti+k共k+1个节点，称区间[ti,ti+k]为Ni,k(t)的支承区间。曲线方程中，n+1个控制顶点Pi(i=0,1,...,n)，要用到n+1个k阶B样条Ni,k(t)。它们支撑区间的并集定义了这一组B样条基的节点矢量T=[t0,t1,...,tn+k]。
    2．性质
    （1）局部支承性。 
        
    （2）权性。
        
    （3）微分公式。
        
    3．B样条曲线类型的划分
    曲线按其首末端点是否重合，区分为闭曲线和开曲线。闭曲线又区分为周期和非周期两种情形，周期闭曲线与非周期闭曲线的区别是：前者在首末端点是C2连续的，而后者一般是C0连续的。非周期闭曲线可以认为是开曲线的特例，按开曲线处理。 
    B样条曲线按其节点矢量中节点的分布情况，可划分为四种类型。假定控制多边形的顶点为Pi(i=0,1,...,n)，阶数为k（次数为k-1），则节点矢量是  T=[t0,t1,...,tn+k]。
    （1）均匀B样条曲线
    节点矢量中节点为沿参数轴均匀或等距分布，所有节点区间长度 样条基。图3.1.23是均匀B样条曲线实例。

图3.1.23 三次均匀的B样条曲线
    （2）准均匀的B样条曲线
    与均匀B样条曲线的差别在于两端节点具有重复度k，这样的节点矢量定义了准均匀的B样条基。
    均匀B样条曲线在曲线定义域内各节点区间上具有用局部参数表示的统一的表达式，使得计算与处理简单方便。但用它定义的均匀B样条曲线没有保留Bezier曲线端点的几何性质，即样条曲线的首末端点不再是控制多边形的首末端点。采用准均匀的B样条曲线就是为了解决这个问题，使曲线在端点的行为有较好的控制，如图3.1.24所示。
    
图3.1.24 准均匀三次B样条曲线
    （3）分段Bezier曲线
    节点矢量中两端节点具有重复度k，所有内节点重复度为k-1，这样的节点矢量定义了分段的Bernstein基。
    B样条曲线用分段Bezier曲线表示后，各曲线段就具有了相对的独立性，移动曲线段内的一个控制顶点只影响该曲线段的形状，对其它曲线段的形状没有影响。并且Bezier曲线一整套简单有效的算法都可以原封不动地采用。其它三种类型的B样条曲线可通过插入节点的方法转换成分段Bezier曲线类型，缺点是增加了定义曲线的数据，控制顶点数及节点数都将增加。分段Bezier曲线实例如图3.1.25所示。

图3.1.25 三次分段Bezier曲线
    （4）非均匀B样条曲线
    在这种类型里，任意分布的节点矢量T=[t1,t2,...,tn+k]，只要在数学上成立（节点序列非递减，两端节点重复度≤k，内节点重复度≤k-1）都可选取。这样的节点矢量定义了非均匀B样条基。

1．局部性
 多与k个控制顶点Pj(j=i-k+1,...,i)有关，与其它控制顶点无关；移动该曲线的第i个控制顶点Pi至多影响到定义在区间(ti,ti+k)上那部分曲线的形状，对曲线的其余部分不发生影响。
    2．连续性
 连续阶不低于k-1-rmax，其中rmax表示位于区间(tk-1,tn+1)内的节点的最大重数。
    3．凸包性 

    4．分段参数多项式

    5．导数公式 
    由B样条基的微分差分公式，有：

    6．变差缩减性
    设平面内n+1个控制顶点P0,P1,...,Pn构成B样条曲线P(t)的特征多边形。在该平面内的任意一条直线与P(t)的交点个数不多于该直线和特征多边形的交点个数。
    7．几何不变性
    B样条曲线的形状和位置与坐标系的选择无关。
    8．仿射不变性
    对任一仿射变换A：
    
    即在仿射变换下，P(t)的表达式具有形式不变性。
    9．直线保持性
    控制多边形退化为一条直线时，曲线也退化为一条直线。
    10．造型的灵活性
    用B样条曲线可以构造直线段、尖点、切线等特殊情况，如图3.1.26所示。对于四阶（三次）B样条曲线P(t)若要在其中得到一条直线段，只要 即为一条直线，且和Pi,Pi+1,Pi+2,Pi+3所在的直线重合。
    为了使P(t)能过Pi点，只要使Pi,Pi+1,Pi+2重合，此时P(t)过Pi点(尖点)，尖点也可通过三重节点的方法得到，与三重顶点的效果相似。
    为了使曲线P(t)和某一直线L相切，只要取Pi,Pi+1,Pi+2位于L上及ti+3的重数不大于2。

给定控制顶点Pi(i=0,1,...,n)及节点矢量T=[t0,t1,...,tn+k]后，就定义了k阶（k-1次）B样条曲线。欲计算B样条曲线上对应一点P(t)，可以利用B样条曲线方程，但是采用de Boor 算法，计算更加快捷。
    1．de Boor 算法的导出

    现令

    则（3.1.17）式可表示为

    上式是同一条曲线P(t)从k阶B样条表示到k-1阶B样条表示的递推公式，
    于是，P(t)的值可以通过递推关系式(3.1.18)求得。这就是著名的de Boor算法，de Boor 算法的递推关系如图3.1.27所示。

图3.1.27 de Boor 算法的递推关系
　
    2．de Boor 算法的几何意义
 如图3.1.28所示。

图3.1.28 B样条曲线的de Boor算法的几何意义
    3．由de Boor 算法导出三次B样条的Bezier表示 
    在使用时，为了减少计算量，希望曲线次数越低越好，但二次曲线是一条抛物线，不能反应曲线的拐点；所以一般使用三次(四阶)样条曲线。下面来讨论三次(四阶)样条曲线与Bezier曲线的关系。由de Boor算法，知下列公式成立：



 P(t)而言，de Boor算法不仅是求P(t)的方法，也是把P(t)转化为一段段Bezier曲线的工具。

# 动画